package net.cold.coldsmod.gearbonuses.skills;

import net.cold.coldsmod.ModSounds;
import net.cold.coldsmod.gearbonuses.effects.ModEffects;
import net.cold.coldsmod.stat.ItemRarityUtils;
import net.minecraft.sounds.SoundSource;
import net.minecraft.world.effect.MobEffectInstance;
import net.minecraft.world.entity.LivingEntity;
import net.minecraft.world.entity.player.Player;
import net.minecraft.world.entity.projectile.AbstractArrow;
import net.minecraft.world.item.ItemStack;
import net.minecraftforge.event.entity.EntityJoinLevelEvent;
import net.minecraftforge.event.entity.living.LivingHurtEvent;
import net.minecraftforge.eventbus.api.SubscribeEvent;

public class ExploitWeaknessApply {

    @SubscribeEvent
    public static void onArrowSpawn(EntityJoinLevelEvent event) {
        if (!(event.getEntity() instanceof AbstractArrow arrow)) return;
        if (!(arrow.getOwner() instanceof Player player)) return;

        if (!player.getPersistentData().getBoolean("exploit_weakness_applied")) return;

        if (!player.hasEffect(ModEffects.EXPLOIT_WEAKNESS_READY.get())) return;

        ItemStack main = player.getMainHandItem();
        ItemStack off  = player.getOffhandItem();

        boolean mainIsBow      = "bow".equals(ItemRarityUtils.getItemType(main));
        boolean mainIsCrossbow = "crossbow".equals(ItemRarityUtils.getItemType(main));
        boolean offIsCrossbow  = "crossbow".equals(ItemRarityUtils.getItemType(off));

        boolean isCrossbow = mainIsCrossbow || (offIsCrossbow && !mainIsBow);
        if (!isCrossbow) return;

        arrow.getPersistentData().putBoolean("exploit_weakness_arrow", true);
    }

    @SubscribeEvent
    public static void onCrossbowProjectileHit(LivingHurtEvent event) {

        // Target check
        LivingEntity target = event.getEntity();
        if (target == null) return;

        if (!(event.getSource().getDirectEntity() instanceof net.minecraft.world.entity.projectile.Projectile projectile))
            return;

        if (!(projectile.getOwner() instanceof Player player))
            return;

        if (!(projectile.getPersistentData().getBoolean("exploit_weakness_arrow"))) return;


        player.removeEffect(ModEffects.EXPLOIT_WEAKNESS_READY.get());
        player.addEffect(new MobEffectInstance(ModEffects.EXPLOIT_WEAKNESS_COOLDOWN.get(), 20*20, 0, false, false));

        // Play sound
        player.level().playSound(
                null,
                player.getX(), player.getY(), player.getZ(),
                ModSounds.EXPLOIT_WEAKNESS.get(),
                SoundSource.PLAYERS,
                2.5F,
                1.0F
        );

        int dex = player.getPersistentData().getInt("totalDex");
        int amplifier = 20 + (int)Math.round(dex * 0.2) - 1;

        target.addEffect(new MobEffectInstance(
                ModEffects.EXPLOIT_WEAKNESS_DEBUFF.get(),
                20 * 10,
                amplifier,
                false,
                true
        ));
    }
}
